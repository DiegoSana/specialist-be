generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String        @id @default(uuid())
  email            String        @unique
  password         String?       // Optional for social login users
  firstName        String
  lastName         String
  phone            String?
  profilePictureUrl String?
  isAdmin          Boolean       @default(false)
  status           UserStatus    @default(PENDING)
  // Social login providers
  googleId         String?       @unique
  facebookId       String?       @unique
  authProvider     AuthProvider  @default(LOCAL)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  contacts         Contact[]     @relation("FromUser")
  contactsReceived Contact[]     @relation("ToUser")
  client           Client?
  professional     Professional?
  requests         Request[]     @relation("Client")
  reviewsGiven     Review[]      @relation("Reviewer")
  inAppNotifications InAppNotification[]

  @@map("users")
}

model Client {
  id                   String   @id @default(uuid())
  userId               String   @unique
  preferences          Json?
  savedProfessionals   String[] @default([])
  searchHistory        Json?
  notificationSettings Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("clients")
}

model Trade {
  id            String                  @id @default(uuid())
  name          String                  @unique
  category      String?
  description   String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  professionals ProfessionalTrade[]
  requests      Request[]

  @@map("trades")
}

model Professional {
  id              String             @id @default(uuid())
  userId          String             @unique
  description     String?
  experienceYears Int?
  status          ProfessionalStatus @default(PENDING_VERIFICATION)
  zone            String?
  city            String             @default("Bariloche")
  address         String?
  whatsapp        String?
  website         String?
  averageRating   Float              @default(0)
  totalReviews    Int                @default(0)
  profileImage    String?
  gallery         String[]
  active          Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  trades          ProfessionalTrade[]
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  requests        Request[]          @relation("Professional")
  reviews         Review[]
  interests       RequestInterest[]

  @@map("professionals")
}

model ProfessionalTrade {
  id             String       @id @default(uuid())
  professionalId String
  tradeId        String
  isPrimary      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  trade          Trade        @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@unique([professionalId, tradeId])
  @@map("professional_trades")
}

model Request {
  id             String        @id @default(uuid())
  clientId       String
  professionalId String?       // Optional for public requests
  tradeId        String?       // Trade for public requests
  isPublic       Boolean       @default(false)
  description    String
  address        String?
  availability   String?
  photos         String[]      @default([])
  status         RequestStatus @default(PENDING)
  quoteAmount    Float?
  quoteNotes     String?
  // Client rating by professional (after work is done)
  clientRating        Int?
  clientRatingComment String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  client         User          @relation("Client", fields: [clientId], references: [id], onDelete: Cascade)
  professional   Professional? @relation("Professional", fields: [professionalId], references: [id], onDelete: Cascade)
  trade          Trade?        @relation(fields: [tradeId], references: [id])
  review         Review?
  interests      RequestInterest[]

  @@map("requests")
}

model RequestInterest {
  id             String       @id @default(uuid())
  requestId      String
  professionalId String
  message        String?      // Optional message from specialist
  createdAt      DateTime     @default(now())
  request        Request      @relation(fields: [requestId], references: [id], onDelete: Cascade)
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([requestId, professionalId])
  @@map("request_interests")
}

model Review {
  id             String       @id @default(uuid())
  reviewerId     String
  professionalId String
  requestId      String?      @unique
  rating         Int
  comment        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  request        Request?     @relation(fields: [requestId], references: [id])
  reviewer       User         @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Contact {
  id          String   @id @default(uuid())
  fromUserId  String
  toUserId    String
  contactType String   @default("whatsapp")
  message     String?
  createdAt   DateTime @default(now())
  fromUser    User     @relation("FromUser", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser      User     @relation("ToUser", fields: [toUserId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

model InAppNotification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  body      String?
  data      Json?
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("in_app_notifications")
}

enum UserRole {
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BANNED
}

enum ProfessionalStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

enum RequestStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  DONE
  CANCELLED
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
}
